<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>server.py</title>
  <link rel="stylesheet" href="pycco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <div class='section'>
    <div class='docs'><h1>server.py</h1></div>
  </div>
  <div class='clearall'>
  <div class='section' id='section-0'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-0'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">argparse</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-1'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-1'>#</a>
      </div>
      <p>db access lib</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="kn">import</span> <span class="nn">MySQLdb</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-2'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-2'>#</a>
      </div>
      <p>irc library
IRCSide main class</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="kn">from</span> <span class="nn">irc</span> <span class="kn">import</span> <span class="n">client</span>

<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">datetime</span>

<span class="kn">import</span> <span class="nn">threading</span> <span class="c"># :)))))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-3'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-3'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">class</span> <span class="nc">IRCSide</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-4'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-4'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_userid</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-5'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-5'>#</a>
      </div>
      <p>super(IRCSide, self).<strong>init</strong>()</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">Reactor</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_handlers</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">server_list_instances</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server_list_server_objects</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">load_servers_from_db</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">connect_servers</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">userID</span> <span class="o">=</span> <span class="n">_userid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cau_ne</span> <span class="o">=</span> <span class="s">&quot;cau&quot;</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">MySQLdb</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="s">&quot;root&quot;</span><span class="p">,</span> <span class="n">passwd</span><span class="o">=</span><span class="s">&quot;asdf&quot;</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="s">&quot;cloudchatdb&quot;</span><span class="p">,</span> <span class="n">connect_timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">charset</span><span class="o">=</span><span class="s">&quot;utf8&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">func_to_be_threaded</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">process_forever</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-6'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-6'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">_func_to_be_threaded</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span><span class="p">(</span><span class="bp">True</span><span class="p">):</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;Sleep 5: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">userID</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-7'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-7'>#</a>
      </div>
      <p>Loads user's servers from the database</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">func_to_be_threaded</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_func_to_be_threaded</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-8'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-8'>#</a>
      </div>
      <p>Adds IRC handlers</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">load_servers_from_db</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">MySQLdb</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="s">&quot;root&quot;</span><span class="p">,</span> <span class="n">passwd</span><span class="o">=</span><span class="s">&quot;asdf&quot;</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="s">&quot;cloudchatdb&quot;</span><span class="p">,</span> <span class="n">connect_timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">charset</span><span class="o">=</span><span class="s">&quot;utf8&quot;</span><span class="p">)</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">userID</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;SELECT * FROM `IRC_servers` WHERE `Registred_users_userID` = </span><span class="si">%s</span><span class="s">;&quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">userID</span><span class="p">,))</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;RESULT&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
        <span class="n">servers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
            <span class="n">server_dict_temp</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;serverID&quot;</span><span class="p">:</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                <span class="s">&quot;serverSessionID&quot;</span><span class="p">:</span> <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                <span class="s">&quot;nickname&quot;</span><span class="p">:</span> <span class="n">res</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                                <span class="s">&quot;isAway&quot;</span><span class="p">:</span> <span class="n">res</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
                                <span class="s">&quot;isConnected&quot;</span><span class="p">:</span> <span class="n">res</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
                                <span class="s">&quot;Registred_users_userID&quot;</span><span class="p">:</span> <span class="n">res</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
                                <span class="s">&quot;serverName&quot;</span><span class="p">:</span> <span class="n">res</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span>
                                <span class="s">&quot;serverIP&quot;</span><span class="p">:</span> <span class="n">res</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span>
                                <span class="s">&quot;serverPort&quot;</span><span class="p">:</span> <span class="n">res</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span>
                                <span class="s">&quot;useSSL&quot;</span><span class="p">:</span> <span class="n">res</span><span class="p">[</span><span class="mi">9</span><span class="p">]}</span>
            <span class="n">servers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">server_dict_temp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server_list_text</span> <span class="o">=</span> <span class="n">servers</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-9'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-9'>#</a>
      </div>
      <p>self.client.add_global_handler("yourhost", self.on_connect)</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">add_handlers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">add_global_handler</span><span class="p">(</span><span class="s">&quot;welcome&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_connect</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-10'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-10'>#</a>
      </div>
      <p>self.client.add_global_handler("created", self.on_connect)
self.client.add_global_handler("myinfo", self.on_connect)</p>
<p>self.client.add_global_handler("nosuchnick", self.on_connect)
self.client.add_global_handler("nosuchcannel", self.on_connect)
self.client.add_global_handler("unknowncommand", self.on_connect)
self.client.add_global_handler("nonicknamegiven", self.on_connect)
self.client.add_global_handler("nicknameinuse", self.on_connect)
self.client.add_global_handler("nickcollison", self.on_connect)
self.client.add_global_handler("notonchannel", self.on_connect)</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">add_global_handler</span><span class="p">(</span><span class="s">&quot;useronchannel&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_connect</span><span class="p">)</span><span class="s">&quot;&quot;&quot;</span>

<span class="s">        self.client.add_global_handler(&quot;yourhost&quot;, self.on_your_host)</span>
<span class="s">        self.client.add_global_handler(&quot;disconnect&quot;, self.on_disconnect)</span>
<span class="s">        self.client.add_global_handler(&quot;nicknameinuse&quot;, self.on_nicknameinuse)</span>
<span class="s">        self.client.add_global_handler(&quot;pubmsg&quot;, self.on_pubmsg)</span>
<span class="s">        self.client.add_global_handler(&quot;privmsg&quot;, self.on_privmsg)</span>
<span class="s">        self.client.add_global_handler(&quot;join&quot;, self.on_pubmsg)</span>
<span class="s">        self.client.add_global_handler(&quot;part&quot;, self.on_pubmsg)</span>
<span class="s">        self.client.add_global_handler(&quot;quit&quot;, self.on_pubmsg)</span>
<span class="s">        self.client.add_global_handler(&quot;nick&quot;, self.on_nick)</span>
<span class="s">        self.client.add_global_handler(&quot;action&quot;, self.on_pubmsg)</span>
<span class="s">#DIVIDER</span>
<span class="s">    def on_your_host(self, connection, event):</span>
<span class="s">        print(&quot;test&quot;)</span>

<span class="s">    &quot;&quot;&quot;</span>
        <span class="n">Called</span> <span class="n">to</span> <span class="n">connect</span> <span class="n">to</span> <span class="n">a</span> <span class="n">specified</span> <span class="n">server</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-11'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-11'>#</a>
      </div>
      <pre><code>def connect_server(self, _serverID, _server, _port, _nickname):
</code></pre>
<p>temp_server_connection_object = self.client.server()</p>
<p>temp_server_connection_object.serverID = _serverID # důležité: přidává serverID z databáze jako atribut do connection, které se používá při každém global_handleru definovaném o pář řádků výše</p>
<p>print(temp_server_connection_object.serverID)
   #temp_server_connection_object.setServerID(_serverID)</p>
<p>self.server_list_server_objects.append(temp_server_connection_object)
   self.server_list_instances.append(temp_server_connection_object.connect(server=_server, port=_port, nickname=_nickname, password=None, username=None, ircname=None))</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">Called</span> <span class="n">upon</span> <span class="n">starting</span> <span class="n">the</span> <span class="n">instance</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-12'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-12'>#</a>
      </div>
      <pre><code>def connect_servers(self):
</code></pre>
<p>for srvr in self.server_list_text:
       try:
           self.connect_server(srvr["serverID"], srvr["serverIP"], int(srvr["serverPort"]), srvr["nickname"])
       except Exception as exp:
           print("Error occurred.\nWhy: {0}".format(exp)) # TOOD: send errors like these to the client!!!</p>
<p>Called: never?</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-13'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-13'>#</a>
      </div>
      <p>Fired when any client successfully connects to an IRC server</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">on_connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;[{}] Connected to {}&#39;</span> <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">event</span><span class="o">.</span><span class="n">source</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">arguments</span><span class="p">))</span>

        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;SELECT * FROM `IRC_servers` WHERE `Registred_users_userID` = </span><span class="si">%s</span><span class="s"> AND `serverID` = </span><span class="si">%s</span><span class="s">;&quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">userID</span><span class="p">,</span> <span class="n">connection</span><span class="o">.</span><span class="n">serverID</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">res</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
            <span class="k">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

            <span class="n">serverID_res</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

            <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;UPDATE `IRC_servers` SET `isConnected` = </span><span class="si">%s</span><span class="s"> WHERE `serverID` = </span><span class="si">%s</span><span class="s">;&quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">serverID_res</span><span class="p">))</span>

            <span class="k">print</span><span class="p">(</span><span class="s">&quot;RES: &quot;</span><span class="p">,</span><span class="n">res</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;serverID = {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">serverID_res</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">serverID_res</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">connection</span><span class="o">.</span><span class="n">serverID</span><span class="p">):</span> <span class="c"># pokud se získané ID z databáze rovná tomu, které v sobě uchovává connection, redundantní check, ale JTS</span>
                <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;SELECT * FROM `IRC_channels` WHERE `IRC_servers_serverID` = </span><span class="si">%s</span><span class="s">;&quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">serverID_res</span><span class="p">,))</span>
                <span class="k">if</span> <span class="n">res</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&quot;Channmessage_windowels for serverID={}: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">serverID_res</span><span class="p">,</span> <span class="n">result</span><span class="p">))</span>

                    <span class="n">channels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

                    <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                        <span class="n">channelID</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">channelName</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">channelPassword</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                        <span class="n">lastOpened</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                        <span class="n">channel_serverID</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                        <span class="n">temp_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;channelName&quot;</span><span class="p">:</span> <span class="n">channelName</span><span class="p">,</span> <span class="s">&quot;channelPassword&quot;</span><span class="p">:</span> <span class="n">channelPassword</span><span class="p">}</span>
                        <span class="n">channels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp_dict</span><span class="p">)</span>


                    <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">channels</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">client</span><span class="o">.</span><span class="n">is_channel</span><span class="p">(</span><span class="n">channel</span><span class="p">[</span><span class="s">&quot;channelName&quot;</span><span class="p">]):</span>
                            <span class="n">connection</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">channel</span><span class="p">[</span><span class="s">&quot;channelName&quot;</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="n">channel</span><span class="p">[</span><span class="s">&quot;channelPassword&quot;</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">print</span><span class="p">(</span><span class="s">&quot;The channel in database is not a channel.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&quot;[WARNING on_connect]: No channels to join on this server (serverID = {})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">serverID_res</span><span class="p">))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-14'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-14'>#</a>
      </div>
      <p>Fired when any client is disconnected from an IRC server</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">on_disconnect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;[{}] Disconnected from {}&#39;</span> <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">event</span><span class="o">.</span><span class="n">source</span><span class="p">))</span>
        <span class="k">pass</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-15'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-15'>#</a>
      </div>
      <p>Fired when any client gets a /ME message from any channel or query</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">on_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;[{}] OnAction from {}&#39;</span> <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">event</span><span class="o">.</span><span class="n">source</span><span class="p">))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-16'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-16'>#</a>
      </div>
      <p>Fired when any client receives a message from a channel</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">on_pubmsg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;CONNECTION = {}</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">connection</span><span class="o">.</span><span class="n">__dict__</span><span class="p">))</span>

        <span class="k">print</span><span class="p">(</span><span class="s">&#39;[{}] Pubmsg {} {}</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">event</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">__dict__</span><span class="p">)))</span>
        <span class="k">if</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">arguments</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">message</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">arguments</span><span class="p">)</span>

        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;SELECT * FROM `IRC_servers` WHERE `Registred_users_userID` = </span><span class="si">%s</span><span class="s"> AND `serverID` = </span><span class="si">%s</span><span class="s">;&quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">userID</span><span class="p">,</span> <span class="n">connection</span><span class="o">.</span><span class="n">serverID</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">res</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
            <span class="k">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="n">serverID_res</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;serverID = {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">serverID_res</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">serverID_res</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">connection</span><span class="o">.</span><span class="n">serverID</span><span class="p">):</span> <span class="c"># pokud se získané ID z databáze rovná tomu, které v sobě uchovává connection, redundantní check, ale JTS</span>
                <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;SELECT * FROM `IRC_channels` WHERE `IRC_servers_serverID` = </span><span class="si">%s</span><span class="s"> AND `channelName` = </span><span class="si">%s</span><span class="s">;&quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">serverID_res</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">target</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">res</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&quot;Channels: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
                    <span class="n">channelID_res</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

                    <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;INSERT INTO `IRC_channel_messages` (IRC_channels_channelID,</span>
<span class="s">                    fromHostmask,</span>
<span class="s">                    messageBody,</span>
<span class="s">                    commandType,</span>
<span class="s">                    timeReceived)</span>
<span class="s">                    values (</span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">)&quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">channelID_res</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&quot;WOAH&quot;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-17'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-17'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-18'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-18'>#</a>
      </div>
      <p>print("Servers??? {0}".format(result))
res2 = self.cursor.execute("""select * from <code>IRC_channels</code> where <code>IRC_servers_serverID</code> = 1;""", (self.userID,))</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-19'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-19'>#</a>
      </div>
      <p>connection.privmsg(event.target, str(event.<strong>dict</strong>))</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">on_privmsg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;[{}] Privmsg {}&#39;</span> <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">event</span><span class="o">.</span><span class="n">source</span><span class="p">))</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">privmsg</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">__dict__</span><span class="p">))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-20'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-20'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">on_join</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;[{}] Join {}&#39;</span> <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">event</span><span class="o">.</span><span class="n">source</span><span class="p">))</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">privmsg</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">__dict__</span><span class="p">))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-21'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-21'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">on_part</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;[{}] Part {}&#39;</span> <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">event</span><span class="o">.</span><span class="n">source</span><span class="p">))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-22'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-22'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">on_quit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;[{}] Quit {}&#39;</span> <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">event</span><span class="o">.</span><span class="n">source</span><span class="p">))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-23'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-23'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">on_nick</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;[{}] NickChange {}&#39;</span> <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">event</span><span class="o">.</span><span class="n">source</span><span class="p">))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-24'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-24'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">on_nicknameinuse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;[{}] NickNameInUse {}&#39;</span> <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">event</span><span class="o">.</span><span class="n">source</span><span class="p">))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-25'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-25'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">class</span> <span class="nc">WSocket</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-26'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-26'>#</a>
      </div>
      <p>WSocket</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">WSocket</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">arg</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-27'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-27'>#</a>
      </div>
      <p>TODO: DELETE THIS</p>
<h1>Numeric table based on the Perl's Net::IRC.</h1>
<p>numeric = {
   "001": "welcome",
   "002": "yourhost",
   "003": "created",
   "004": "myinfo",
   "005": "featurelist",  # XXX
   "200": "tracelink",
   "201": "traceconnecting",
   "202": "tracehandshake",
   "203": "traceunknown",
   "204": "traceoperator",
   "205": "traceuser",
   "206": "traceserver",
   "207": "traceservice",
   "208": "tracenewtype",
   "209": "traceclass",
   "210": "tracereconnect",
   "211": "statslinkinfo",
   "212": "statscommands",
   "213": "statscline",
   "214": "statsnline",
   "215": "statsiline",
   "216": "statskline",
   "217": "statsqline",
   "218": "statsyline",
   "219": "endofstats",
   "221": "umodeis",
   "231": "serviceinfo",
   "232": "endofservices",
   "233": "service",
   "234": "servlist",
   "235": "servlistend",
   "241": "statslline",
   "242": "statsuptime",
   "243": "statsoline",
   "244": "statshline",
   "250": "luserconns",
   "251": "luserclient",
   "252": "luserop",
   "253": "luserunknown",
   "254": "luserchannels",
   "255": "luserme",
   "256": "adminme",
   "257": "adminloc1",
   "258": "adminloc2",
   "259": "adminemail",
   "261": "tracelog",
   "262": "endoftrace",
   "263": "tryagain",
   "265": "n_local",
   "266": "n_global",
   "300": "none",
   "301": "away",
   "302": "userhost",
   "303": "ison",
   "305": "unaway",
   "306": "nowaway",
   "311": "whoisuser",
   "312": "whoisserver",
   "313": "whoisoperator",
   "314": "whowasuser",
   "315": "endofwho",
   "316": "whoischanop",
   "317": "whoisidle",
   "318": "endofwhois",
   "319": "whoischannels",
   "321": "liststart",
   "322": "list",
   "323": "listend",
   "324": "channelmodeis",
   "329": "channelcreate",
   "330": "whoisaccount", # <nick> <accountName> :<info> - Spawned from a /whois
   "331": "notopic",
   "332": "currenttopic",
   "333": "topicinfo",
   "341": "inviting",
   "342": "summoning",
   "346": "invitelist",
   "347": "endofinvitelist",
   "348": "exceptlist",
   "349": "endofexceptlist",
   "351": "version",
   "352": "whoreply",
   "353": "namreply",
   "354": "whospcrpl", # Response to a WHOX query
   "361": "killdone",
   "362": "closing",
   "363": "closeend",
   "364": "links",
   "365": "endoflinks",
   "366": "endofnames",
   "367": "banlist",
   "368": "endofbanlist",
   "369": "endofwhowas",
   "371": "info",
   "372": "motd",
   "373": "infostart",
   "374": "endofinfo",
   "375": "motdstart",
   "376": "endofmotd",
   "377": "motd2",        # 1997-10-16 -- tkil
   "381": "youreoper",
   "382": "rehashing",
   "384": "myportis",
   "391": "time",
   "392": "usersstart",
   "393": "users",
   "394": "endofusers",
   "395": "nousers",
   "401": "nosuchnick",
   "402": "nosuchserver", #nosuchnick, nosuchcannel, unknowncommand, nonicknamegiven, nicknameinuse, nickcollison, notonchannel, useronchannel
   "403": "nosuchchannel",
   "404": "cannotsendtochan",
   "405": "toomanychannels",
   "406": "wasnosuchnick",
   "407": "toomanytargets",
   "409": "noorigin",
   "410": "invalidcapcmd",
   "411": "norecipient",
   "412": "notexttosend",
   "413": "notoplevel",
   "414": "wildtoplevel",
   "421": "unknowncommand",
   "422": "nomotd",
   "423": "noadmininfo",
   "424": "fileerror",
   "431": "nonicknamegiven",
   "432": "erroneusnickname",  # Thiss iz how its speld in thee RFC.
   "433": "nicknameinuse",
   "436": "nickcollision",
   "437": "unavailresource",  # "Nick temporally unavailable"
   "441": "usernotinchannel",
   "442": "notonchannel",
   "443": "useronchannel",
   "444": "nologin",
   "445": "summondisabled",
   "446": "usersdisabled",
   "451": "notregistered",
   "461": "needmoreparams",
   "462": "alreadyregistered",
   "463": "nopermforhost",
   "464": "passwdmismatch",
   "465": "yourebannedcreep",  # I love this one...
   "466": "youwillbebanned",
   "467": "keyset",
   "471": "channelisfull",
   "472": "unknownmode",
   "473": "inviteonlychan",
   "474": "bannedfromchan",
   "475": "badchannelkey",
   "476": "badchanmask",
   "477": "nochanmodes",  # "Channel doesn't support modes"
   "478": "banlistfull",
   "480": "cannotknock", #generated when /knock <chan> is ran on a channel that you are either in or has /knock'ing disabled
   "481": "noprivileges",
   "482": "chanoprivsneeded",
   "483": "cantkillserver",
   "484": "restricted",   # Connection is restricted
   "485": "uniqopprivsneeded",
   "491": "nooperhost",
   "492": "noservicehost",
   "501": "umodeunknownflag",
   "502": "usersdontmatch",
}</p>
<p>codes = dict((v, k) for k, v in numeric.items())</p>
<p>generated = [
   "dcc_connect",
   "dcc_disconnect",
   "dccmsg",
   "disconnect",
   "ctcp",
   "ctcpreply",
]</p>
<p>protocol = [
   "error",
   "join",
   "kick",
   "mode",
   "part",
   "ping",
   "privmsg",
   "privnotice",
   "pubmsg",
   "pubnotice",
   "quit",
   "invite",
   "pong",
   "action",
   "topic",
   "nick",
]</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-28'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-28'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
</div>
</body>
