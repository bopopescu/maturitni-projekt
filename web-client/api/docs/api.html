<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>api.py</title>
  <link rel="stylesheet" href="pycco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <div class='section'>
    <div class='docs'><h1>api.py</h1></div>
  </div>
  <div class='clearall'>
  <div class='section' id='section-0'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-0'>#</a>
      </div>
      <p>TODO: http://flask.pocoo.org/docs/0.10/patterns/packages/
TODO: http://flask.pocoo.org/docs/0.10/patterns/packages/
TODO: http://flask.pocoo.org/docs/0.10/patterns/packages/
TODO: http://flask.pocoo.org/docs/0.10/patterns/packages/
TODO: http://flask.pocoo.org/docs/0.10/patterns/packages/
TODO: http://flask.pocoo.org/docs/0.10/patterns/packages/
TODO: http://flask.pocoo.org/docs/0.10/patterns/packages/
TODO: http://flask.pocoo.org/docs/0.10/patterns/packages/
TODO: http://flask.pocoo.org/docs/0.10/patterns/packages/
TODO: http://flask.pocoo.org/docs/0.10/patterns/packages/
TODO: http://flask.pocoo.org/docs/0.10/patterns/packages/
TODO2: http://flask.pocoo.org/docs/0.10/deploying/mod_wsgi/
TODO2: http://flask.pocoo.org/docs/0.10/deploying/mod_wsgi/
TODO2: http://flask.pocoo.org/docs/0.10/deploying/mod_wsgi/
TODO2: http://flask.pocoo.org/docs/0.10/deploying/mod_wsgi/
TODO2: http://flask.pocoo.org/docs/0.10/deploying/mod_wsgi/
TODO2: http://flask.pocoo.org/docs/0.10/deploying/mod_wsgi/
TODO2: http://flask.pocoo.org/docs/0.10/deploying/mod_wsgi/
TODO2: http://flask.pocoo.org/docs/0.10/deploying/mod_wsgi/
TODO3: Check for invalid data in forms
TODO3: Check for invalid data in forms
TODO3: Check for invalid data in forms
TODO3: Check for invalid data in forms
TODO3: Check for invalid data in forms</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-1'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-1'>#</a>
      </div>
      <p>db access lib</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="kn">import</span> <span class="nn">MySQLdb</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-2'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-2'>#</a>
      </div>
      <p>passlib for password hashing</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="kn">from</span> <span class="nn">passlib.hash</span> <span class="kn">import</span> <span class="n">sha512_crypt</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-3'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-3'>#</a>
      </div>
      <p>re for regular expressions parsing</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="kn">import</span> <span class="nn">re</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-4'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-4'>#</a>
      </div>
      <p>randomness for session IDs</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">urandom</span>
<span class="kn">from</span> <span class="nn">base64</span> <span class="kn">import</span> <span class="n">b64encode</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span>
<span class="kn">import</span> <span class="nn">datetime</span>


<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">jsonify</span><span class="p">,</span> <span class="n">redirect</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>


<span class="kn">from</span> <span class="nn">werkzeug.exceptions</span> <span class="kn">import</span> <span class="n">default_exceptions</span>
<span class="kn">from</span> <span class="nn">werkzeug.exceptions</span> <span class="kn">import</span> <span class="n">HTTPException</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-5'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-5'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">is_email_valid</span><span class="p">(</span><span class="n">email_to_check</span><span class="p">):</span> <span class="c"># TODO: maybe move to api_utils or sth??????</span>
    <span class="n">regexp</span> <span class="o">=</span> <span class="s">r&quot;(^[a-zA-Z0-9_.+-]+@[a-zA-Z0-9-]+\.[a-zA-Z0-9-.]+$)&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">regexp</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">email_to_check</span><span class="p">))</span> <span class="c"># if we conv to string we don&#39;t have to care about checking if the string is None and the regexp will just say it&#39;s not a valid email address, i will forever wonder what is faster, probably checking for None, but we may never be sure and I am too lazy to test it out so instead I am writing out this long comment on a single line without word wrapping just to calm myself down</span>
    <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">True</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-6'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-6'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">error</span><span class="p">(</span><span class="n">_status</span><span class="p">,</span> <span class="n">_reason</span><span class="p">,</span> <span class="n">_message</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">_status</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="n">_reason</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="n">_message</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-7'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-7'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">get_userIP</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">remote_addr</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-8'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-8'>#</a>
      </div>
      <p>this function checks for a sessionID in the database and joins it with the userID of a user</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">_make_login_response</span><span class="p">(</span><span class="n">data_to_send</span><span class="p">,</span> <span class="n">generated_sessionID</span><span class="p">):</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">make_response</span><span class="p">(</span><span class="n">data_to_send</span><span class="p">)</span>
    <span class="n">response</span><span class="o">.</span><span class="n">set_cookie</span><span class="p">(</span><span class="s">&quot;sessionid&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">generated_sessionID</span><span class="p">)</span>
    <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&quot;Access-Control-Allow-Origin&quot;</span><span class="p">,</span> <span class="s">&quot;localhost&quot;</span><span class="p">)</span>
    <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&quot;Access-Control-Allow-Headers&quot;</span><span class="p">,</span> <span class="s">&quot;Content-Type,Authorization,Cookies&quot;</span><span class="p">)</span>
    <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&quot;Access-Control-Allow-Methods&quot;</span><span class="p">,</span> <span class="s">&quot;GET,PUT,POST,DELETE&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-9'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-9'>#</a>
      </div>
      <p>this is used to check if the user is allowed to request the data he's requesting
aka if he's not trying to access data of a user with a different ID</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-10'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-10'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">get_userID_if_loggedin</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="s">&quot;sessionid&quot;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">cookies</span><span class="p">:</span>
        <span class="n">session_id_cookie</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;sessionid&quot;</span><span class="p">)</span>
        <span class="n">db</span><span class="o">=</span><span class="n">MySQLdb</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="s">&quot;root&quot;</span><span class="p">,</span> <span class="n">passwd</span><span class="o">=</span><span class="s">&quot;asdf&quot;</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="s">&quot;cloudchatdb&quot;</span><span class="p">,</span> <span class="n">connect_timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">charset</span><span class="o">=</span><span class="s">&quot;utf8&quot;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;session_id_cookie = &quot;</span><span class="p">,</span> <span class="n">session_id_cookie</span><span class="p">)</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">result_code</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;SELECT * FROM `User_sessions` WHERE `session_id` = </span><span class="si">%s</span><span class="s">&quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">session_id_cookie</span><span class="p">,))</span>
        <span class="k">if</span> <span class="n">result_code</span> <span class="ow">is</span> <span class="ow">not</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
            <span class="n">session_id</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">userID</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
            <span class="k">print</span><span class="p">(</span><span class="n">session_id</span><span class="p">,</span> <span class="n">userID</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">session_id</span> <span class="o">==</span> <span class="n">session_id_cookie</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">userID</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-11'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-11'>#</a>
      </div>
      <p>Checks if a given serverID belongs to a given userID and returns True/False</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">check_if_serverID_belongs_to_userID</span><span class="p">(</span><span class="n">userID</span><span class="p">,</span> <span class="n">serverID</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-12'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-12'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">db</span><span class="o">=</span><span class="n">MySQLdb</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="s">&quot;root&quot;</span><span class="p">,</span> <span class="n">passwd</span><span class="o">=</span><span class="s">&quot;asdf&quot;</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="s">&quot;cloudchatdb&quot;</span><span class="p">,</span> <span class="n">connect_timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">charset</span><span class="o">=</span><span class="s">&quot;utf8&quot;</span><span class="p">)</span>

    <span class="n">cursor</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">result_code</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;SELECT * FROM `IRC_servers` WHERE `serverID` = </span><span class="si">%s</span><span class="s"> AND `Registred_users_userID` = </span><span class="si">%s</span><span class="s">&quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">serverID</span><span class="p">,</span> <span class="n">userID</span><span class="p">,))</span>
    <span class="k">if</span> <span class="n">result_code</span> <span class="ow">is</span> <span class="ow">not</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>

        <span class="n">serverID_result</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">userID_result</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">serverID_result</span> <span class="o">==</span> <span class="n">serverID</span> <span class="ow">and</span> <span class="n">userID_result</span> <span class="o">==</span> <span class="n">userID</span><span class="p">:</span> <span class="c"># redundant check, but whatever, this app is already slow af, anyway</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
    <span class="k">return</span> <span class="bp">False</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-13'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-13'>#</a>
      </div>
      <p>after request, pro povoleni CORS requestů z javascriptu
Adds CORS allowing headers to the response before sending it to the client.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@app.after_request</span>
<span class="k">def</span> <span class="nf">after_request</span><span class="p">(</span><span class="n">response</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-14'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-14'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&quot;Access-Control-Allow-Origin&quot;</span><span class="p">,</span> <span class="s">&quot;http://localhost&quot;</span><span class="p">)</span>
    <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&quot;Access-Control-Allow-Headers&quot;</span><span class="p">,</span> <span class="s">&quot;Content-Type,Authorization,Cookies&quot;</span><span class="p">)</span>
    <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&quot;Access-Control-Allow-Methods&quot;</span><span class="p">,</span> <span class="s">&quot;GET,PUT,POST,DELETE&quot;</span><span class="p">)</span>
    <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&quot;Access-Control-Allow-Credentials&quot;</span><span class="p">,</span> <span class="s">&quot;true&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-15'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-15'>#</a>
      </div>
      <p>Defaultní routa</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">hello_world</span><span class="p">():</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-16'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-16'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">if</span> <span class="s">&quot;sessionid&quot;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">cookies</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;request.cookies&quot;</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">cookies</span><span class="p">)</span>
        <span class="n">asdf</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="s">&quot;ok&quot;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">cookies</span><span class="p">[</span><span class="s">&quot;sessionid&quot;</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">asdf</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">asdf</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="s">&quot;ok&quot;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s">&quot;API is up.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">asdf</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-17'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-17'>#</a>
      </div>
      <p>Routa zařizující odhlášerní uživatele</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/logout&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;POST&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">logout</span><span class="p">():</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-18'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-18'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">if</span> <span class="s">&quot;sessionid&quot;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">cookies</span><span class="p">:</span>
        <span class="n">db</span><span class="o">=</span><span class="n">MySQLdb</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="s">&quot;root&quot;</span><span class="p">,</span> <span class="n">passwd</span><span class="o">=</span><span class="s">&quot;asdf&quot;</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="s">&quot;cloudchatdb&quot;</span><span class="p">,</span> <span class="n">connect_timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">charset</span><span class="o">=</span><span class="s">&quot;utf8&quot;</span><span class="p">)</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">cookies_sessionid</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;sessionid&quot;</span><span class="p">)</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">result_code</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;SELECT * FROM `User_sessions` WHERE `session_id` = </span><span class="si">%s</span><span class="s">&quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">cookies_sessionid</span><span class="p">,))</span>

        <span class="k">print</span><span class="p">(</span><span class="s">&quot;session_id cookie:&quot;</span><span class="p">,</span> <span class="n">cookies_sessionid</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">result_code</span> <span class="ow">is</span> <span class="ow">not</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">session_id</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">session_id_cookie</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;sessionid&quot;</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;session_id DB:&quot;</span><span class="p">,</span> <span class="n">session_id</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;session_id cookie:&quot;</span><span class="p">,</span> <span class="n">cookies_sessionid</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">session_id</span> <span class="o">==</span> <span class="n">session_id_cookie</span><span class="p">:</span>
                <span class="n">cursor</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-19'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-19'>#</a>
      </div>
      <p>delete the session cookie from database</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                <span class="n">result_code</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;DELETE FROM `User_sessions` WHERE `session_id` = </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">session_id</span><span class="p">,))</span>
                <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                <span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">print</span><span class="p">(</span><span class="s">&quot;Reached the end of checking the session cookie with the one in DB.&quot;</span><span class="p">,</span>
              <span class="s">&quot;The current cookie session does not exist (anymore). The user is logged out.&quot;</span><span class="p">,</span>
              <span class="s">&quot;It&#39;s time to remove his cookie.&quot;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-20'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-20'>#</a>
      </div>
      <p>delete the cookie from client's browser, we delete it even if it isn't in the database. as he's trying to login with an invalid sessionid</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">data</span> <span class="o">=</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="s">&quot;ok&quot;</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="s">&quot;loggedout&quot;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s">&quot;Logged out successfully.&quot;</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">make_response</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">set_cookie</span><span class="p">(</span><span class="s">&quot;sessionid&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">expires</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-21'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-21'>#</a>
      </div>
      <p>response.headers.add('Access-Control-Allow-Origin', "http://localhost")
response.headers.add('Access-Control-Allow-Headers', 'Content-Type,Authorization,Cookies')
response.headers.add('Access-Control-Allow-Methods', 'GET,PUT,POST,DELETE')
response.headers.add('Access-Control-Allow-Credentials', 'true')</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">return</span> <span class="n">response</span>
    <span class="k">else</span><span class="p">:</span>
         <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="s">&quot;error&quot;</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="s">&quot;not_loggedin&quot;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s">&quot;You are not logged in.&quot;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-22'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-22'>#</a>
      </div>
      <p>routa volaná při načtení chat.html pro ověření, zda je uživatel přihlášen
Routa volaná při načtení klientského chat.html, vrací email přihlášeného uživatele</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/upon_login&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;POST&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">upon_login</span><span class="p">():</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-23'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-23'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">userID</span> <span class="o">=</span> <span class="n">get_userID_if_loggedin</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&quot;UserID = &quot;</span><span class="p">,</span> <span class="n">userID</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">userID</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">False</span><span class="p">:</span>
        <span class="n">db</span><span class="o">=</span><span class="n">MySQLdb</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="s">&quot;root&quot;</span><span class="p">,</span> <span class="n">passwd</span><span class="o">=</span><span class="s">&quot;asdf&quot;</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="s">&quot;cloudchatdb&quot;</span><span class="p">,</span> <span class="n">connect_timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">charset</span><span class="o">=</span><span class="s">&quot;utf8&quot;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;Hello boys&quot;</span><span class="p">)</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;SELECT (email) FROM `Registered_users` WHERE `userID` = </span><span class="si">%s</span><span class="s">&quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">userID</span><span class="p">,))</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
        <span class="n">_email</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;Email&quot;</span> <span class="o">+</span> <span class="n">_email</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="s">&quot;ok&quot;</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="s">&quot;loggedin_email_status&quot;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="n">_email</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="s">&quot;error&quot;</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="s">&quot;not_loggedin&quot;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s">&quot;You are not logged in.&quot;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-24'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-24'>#</a>
      </div>
      <p>routa volaná při načtení chat.html pro ověření, zda je uživatel přihlášen</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/check_session&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;GET&quot;</span><span class="p">,</span> <span class="s">&quot;POST&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">check_session</span><span class="p">():</span>
    <span class="n">userID</span> <span class="o">=</span> <span class="n">get_userID_if_loggedin</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&quot;UserID = &quot;</span><span class="p">,</span> <span class="n">userID</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">userID</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">False</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="s">&quot;ok&quot;</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="s">&quot;alive_loggedin&quot;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="s">&quot;error&quot;</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="s">&quot;alive_not_loggedin&quot;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s">&quot;You are not logged in.&quot;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-25'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-25'>#</a>
      </div>
      <p>routa volaná při přihlášení na login.html
Routa volaná při přihlášení na login.html</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/login&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;POST&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">login</span><span class="p">():</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-26'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-26'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">_email</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;email&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="c"># WARNING: make lower() because USER@EXAMPLE.COM is the same as UsER@eXamPle.com !!!!!</span>
    <span class="n">_password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;password&quot;</span><span class="p">)</span>
    <span class="n">_hashed_password</span> <span class="o">=</span> <span class="n">sha512_crypt</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">_password</span><span class="p">,</span> <span class="n">salt</span><span class="o">=</span><span class="s">&quot;CodedSaltIsBad&quot;</span><span class="p">)</span>

    <span class="n">db</span><span class="o">=</span><span class="n">MySQLdb</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="s">&quot;root&quot;</span><span class="p">,</span> <span class="n">passwd</span><span class="o">=</span><span class="s">&quot;asdf&quot;</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="s">&quot;cloudchatdb&quot;</span><span class="p">,</span> <span class="n">connect_timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">charset</span><span class="o">=</span><span class="s">&quot;utf8&quot;</span><span class="p">)</span>

    <span class="n">cursor</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">result_code</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;SELECT * FROM `Registered_users` WHERE `email` = </span><span class="si">%s</span><span class="s"> AND `password` = </span><span class="si">%s</span><span class="s">&quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">_email</span><span class="p">,</span> <span class="n">_hashed_password</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">result_code</span> <span class="ow">is</span> <span class="ow">not</span> <span class="mi">0</span><span class="p">:</span> <span class="c"># use &quot;is not&quot; for extra speed (not like it matters, all code around here is slow anyway)</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
        <span class="n">_id</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="s">&quot;sessionid&quot;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">cookies</span><span class="p">:</span>
            <span class="n">cookies_sessionid</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;sessionid&quot;</span><span class="p">)</span>
            <span class="n">cursor</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
            <span class="n">result_code</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;SELECT * FROM `User_sessions` WHERE `Registred_users_userID` = </span><span class="si">%s</span><span class="s">&quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">_id</span><span class="p">,))</span>
            <span class="k">if</span> <span class="n">result_code</span> <span class="ow">is</span> <span class="ow">not</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">session_id</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

                <span class="n">session_id_cookie</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;sessionid&quot;</span><span class="p">)</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&quot;session_id DB:&quot;</span><span class="p">,</span> <span class="n">session_id</span><span class="p">)</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&quot;session_id cookie:&quot;</span><span class="p">,</span> <span class="n">session_id_cookie</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">session_id</span> <span class="o">==</span> <span class="n">session_id_cookie</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&quot;At this point, we are already logged in. Redirect the user here!!!!&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="s">&quot;ok&quot;</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="s">&quot;already_loggedin&quot;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s">&quot;You are already logged in.&quot;</span><span class="p">)</span>

            <span class="k">print</span><span class="p">(</span><span class="s">&quot;Reached the end of checking the session cookie with the one in DB.&quot;</span><span class="p">,</span>
                  <span class="s">&quot;The current cookie session does not exist. Gonna relog now.&quot;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-27'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-27'>#</a>
      </div>
      <p>remove any original session we had (stupid, but whatever, I'd rather pass my last year of high school than have a good session system</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">cursor</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">result_code</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;DELETE FROM `User_sessions` WHERE `Registred_users_userID` = </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">_id</span><span class="p">,))</span>
        <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="n">generated_sessionID</span> <span class="o">=</span> <span class="n">b64encode</span><span class="p">(</span><span class="n">urandom</span><span class="p">(</span><span class="mi">64</span><span class="p">))</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;Generated sessionID&quot;</span><span class="p">,</span> <span class="n">generated_sessionID</span><span class="p">)</span>

        <span class="n">result_code</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;INSERT INTO `User_sessions` (session_id, Registred_users_userID) values (</span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">)&quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">generated_sessionID</span><span class="p">,</span> <span class="n">_id</span><span class="p">),</span> <span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">result_code</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">data_to_send</span> <span class="o">=</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="s">&quot;ok&quot;</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="s">&quot;cookie_ok&quot;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s">&quot;Logged in successfully.&quot;</span><span class="p">,</span> <span class="n">sessionid</span><span class="o">=</span><span class="n">generated_sessionID</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">make_response</span><span class="p">(</span><span class="n">data_to_send</span><span class="p">)</span>
            <span class="n">response</span><span class="o">.</span><span class="n">set_cookie</span><span class="p">(</span><span class="s">&quot;sessionid&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">generated_sessionID</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-28'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-28'>#</a>
      </div>
      <p>response.headers['Access-Control-Allow-Origin'] = "http://localhost"
response.headers['Access-Control-Allow-Headers'] = 'Content-Type,Authorization,Cookies'
response.headers['Access-Control-Allow-Methods'] = 'GET,PUT,POST,DELETE'
response.headers['Access-Control-Allow-Credentials'] = 'true'</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-29'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-29'>#</a>
      </div>
      <p>print("RESPONSE", response)</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="k">return</span> <span class="n">response</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">error</span><span class="p">(</span><span class="s">&quot;error&quot;</span><span class="p">,</span> <span class="s">&quot;loginerror&quot;</span><span class="p">,</span> <span class="s">&quot;An error occurred while trying to log you in.&quot;</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">result_code</span> <span class="ow">is</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">error</span><span class="p">(</span><span class="s">&quot;error&quot;</span><span class="p">,</span> <span class="s">&quot;badlogin&quot;</span><span class="p">,</span> <span class="s">&quot;The login information you have provided is incorrect.&lt;br&gt;Check your email address and password and try again.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="s">&quot;error&quot;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s">&quot;REACHED END OF LOGIN() WITHOUT RETURNING BEFORE THAT, THIS SHOULD NEVER HAPPEN.&quot;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-30'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-30'>#</a>
      </div>
      <p>routa volaná při registraci na index.html</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/register&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;POST&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">register</span><span class="p">():</span>
    <span class="n">db</span><span class="o">=</span><span class="n">MySQLdb</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="s">&quot;root&quot;</span><span class="p">,</span> <span class="n">passwd</span><span class="o">=</span><span class="s">&quot;asdf&quot;</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="s">&quot;cloudchatdb&quot;</span><span class="p">,</span> <span class="n">connect_timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">charset</span><span class="o">=</span><span class="s">&quot;utf8&quot;</span><span class="p">)</span>
    <span class="n">_email</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">_password</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">_email</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;email&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span> <span class="bp">None</span> <span class="c"># WARNING: make lower() because USER@EXAMPLE.COM is the same as UsER@eXamPle.com !!!!!</span>
        <span class="n">_password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;password&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">None</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="s">&quot;error&quot;</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="s">&quot;email_invalid&quot;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s">&quot;The email address you have specified is invalid.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">is_email_valid</span><span class="p">(</span><span class="n">_email</span><span class="p">)</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span> <span class="c"># checking for email&#39;s validness automatically already checks if it&#39;s empty</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="s">&quot;error&quot;</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="s">&quot;email_invalid&quot;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s">&quot;The email address you have specified is invalid.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">_password</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="s">&quot;error&quot;</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="s">&quot;password_empty&quot;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s">&quot;The password is empty.&quot;</span><span class="p">)</span>

    <span class="n">_email</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">_email</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">_hashed_password</span> <span class="o">=</span> <span class="n">sha512_crypt</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">_password</span><span class="p">,</span> <span class="n">salt</span><span class="o">=</span><span class="s">&quot;CodedSaltIsBad&quot;</span><span class="p">)</span>

    <span class="n">cursor</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;SELECT (email) FROM `Registered_users` WHERE `email` = </span><span class="si">%s</span><span class="s">;&quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">_email</span><span class="p">,))</span>
    <span class="n">exists_result</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">affected_rows</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">exists_result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="s">&quot;error&quot;</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="s">&quot;account_exists&quot;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s">&quot;An account with this email address is already registered,&lt;br&gt;please login instead.&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">exists_result</span> <span class="ow">is</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">_result</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;INSERT INTO `Registered_users` (email, password, isActivated) values (</span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">);&quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">_email</span><span class="p">,</span> <span class="n">_hashed_password</span><span class="p">,</span> <span class="mi">1</span><span class="p">),)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">_result</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="s">&quot;ok&quot;</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="s">&quot;reg_success&quot;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s">&quot;Your account was sucessfully registered. You can now login.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="s">&quot;error&quot;</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="s">&quot;insert_failed&quot;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s">&quot;Account registration failed.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="s">&quot;error&quot;</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="s">&quot;insert_failed&quot;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s">&quot;Account registration failed.&quot;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-31'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-31'>#</a>
      </div>
      <p>routa volaná při načtení chat.html
routa volaná při přidání / odstranění serveru</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/get_server_list&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;GET&quot;</span><span class="p">,</span> <span class="s">&quot;POST&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">get_server_list</span><span class="p">():</span>
    <span class="n">userID</span> <span class="o">=</span> <span class="n">get_userID_if_loggedin</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&quot;UserID = &quot;</span><span class="p">,</span> <span class="n">userID</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">userID</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">False</span><span class="p">:</span>
        <span class="n">db</span><span class="o">=</span><span class="n">MySQLdb</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="s">&quot;root&quot;</span><span class="p">,</span> <span class="n">passwd</span><span class="o">=</span><span class="s">&quot;asdf&quot;</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="s">&quot;cloudchatdb&quot;</span><span class="p">,</span> <span class="n">connect_timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">charset</span><span class="o">=</span><span class="s">&quot;utf8&quot;</span><span class="p">)</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;SELECT * FROM `IRC_servers` WHERE `Registred_users_userID` = </span><span class="si">%s</span><span class="s">;&quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">userID</span><span class="p">,))</span>
        <span class="k">if</span> <span class="n">res</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-32'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-32'>#</a>
      </div>
      <p>horrible hacks to get aronud the fact that jsonify is stupid (imo) follow: #</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">servers</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                <span class="n">server_dict_temp</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;serverID&quot;</span><span class="p">:</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                    <span class="s">&quot;serverSessionID&quot;</span><span class="p">:</span> <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                    <span class="s">&quot;nickname&quot;</span><span class="p">:</span> <span class="n">res</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                                    <span class="s">&quot;isAway&quot;</span><span class="p">:</span> <span class="n">res</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
                                    <span class="s">&quot;isConnected&quot;</span><span class="p">:</span> <span class="n">res</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
                                    <span class="s">&quot;Registred_users_userID&quot;</span><span class="p">:</span> <span class="n">res</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
                                    <span class="s">&quot;serverName&quot;</span><span class="p">:</span> <span class="n">res</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span>
                                    <span class="s">&quot;serverIP&quot;</span><span class="p">:</span> <span class="n">res</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span>
                                    <span class="s">&quot;serverPort&quot;</span><span class="p">:</span> <span class="n">res</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span>
                                    <span class="s">&quot;useSSL&quot;</span><span class="p">:</span> <span class="n">res</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span>
                                    <span class="s">&quot;channels&quot;</span><span class="p">:</span> <span class="bp">None</span><span class="p">}</span>
                <span class="n">servers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">server_dict_temp</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span>

            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">srvr</span> <span class="ow">in</span> <span class="n">servers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">print</span><span class="p">(</span><span class="n">srvr</span><span class="p">)</span>
                <span class="n">srvrID</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">srvr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s">&quot;serverID&quot;</span><span class="p">])</span>
                <span class="n">cursor</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;SELECT * FROM `IRC_channels` WHERE `IRC_servers_serverID` = </span><span class="si">%s</span><span class="s">;&quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">srvrID</span><span class="p">,))</span>
                <span class="n">channel_result</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&quot;CHANNELS&quot;</span><span class="p">,</span> <span class="n">channel_result</span><span class="p">)</span>
                <span class="n">channels_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

                <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">channel_result</span><span class="p">:</span>
                    <span class="n">channel_dict_temp</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;channelID&quot;</span><span class="p">:</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                         <span class="s">&quot;channelName&quot;</span><span class="p">:</span> <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                         <span class="s">&quot;channelPassword&quot;</span><span class="p">:</span> <span class="n">res</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                                         <span class="s">&quot;isJoined&quot;</span><span class="p">:</span> <span class="n">res</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
                                         <span class="s">&quot;lastOpened&quot;</span><span class="p">:</span> <span class="n">res</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
                                         <span class="s">&quot;serverID&quot;</span><span class="p">:</span> <span class="n">res</span><span class="p">[</span><span class="mi">5</span><span class="p">]}</span>
                    <span class="n">channels_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">channel_dict_temp</span><span class="p">)</span>

                <span class="n">servers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s">&quot;channels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">channels_list</span>

                <span class="n">i</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;SERVERS!!!!&quot;</span><span class="p">,</span> <span class="n">servers</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;status&quot;</span><span class="p">:</span> <span class="s">&quot;ok&quot;</span><span class="p">,</span> <span class="s">&quot;reason&quot;</span><span class="p">:</span> <span class="s">&quot;listing_servers&quot;</span><span class="p">,</span> <span class="s">&quot;message&quot;</span><span class="p">:</span> <span class="n">servers</span><span class="p">}</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">error</span><span class="p">(</span><span class="s">&quot;ok&quot;</span><span class="p">,</span> <span class="s">&quot;no_servers_to_list&quot;</span><span class="p">,</span> <span class="s">&quot;No servers yet.&quot;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-33'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-33'>#</a>
      </div>
      <p>return error("error", "debug", result)</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">error</span><span class="p">(</span><span class="s">&quot;error&quot;</span><span class="p">,</span> <span class="s">&quot;not_loggedin&quot;</span><span class="p">,</span> <span class="s">&quot;You are not logged in.&quot;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-34'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-34'>#</a>
      </div>
      <p>routa volaná při přidávání kanálu do databáze uživatele</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/add_channel&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;POST&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">add_channel</span><span class="p">():</span>
    <span class="n">userID</span> <span class="o">=</span> <span class="n">get_userID_if_loggedin</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="n">channelName</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;channelName&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">None</span>
    <span class="n">channelPassword</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;channelPassword&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s">&quot;&quot;</span>
    <span class="n">serverID</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;serverID&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s">&quot;&quot;</span>

    <span class="k">if</span> <span class="n">userID</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">False</span> <span class="ow">and</span> <span class="n">channelName</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">MySQLdb</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="s">&quot;root&quot;</span><span class="p">,</span> <span class="n">passwd</span><span class="o">=</span><span class="s">&quot;asdf&quot;</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="s">&quot;cloudchatdb&quot;</span><span class="p">,</span> <span class="n">connect_timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">charset</span><span class="o">=</span><span class="s">&quot;utf8&quot;</span><span class="p">)</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-35'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-35'>#</a>
      </div>
      <p>přidáme server</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;INSERT INTO `IRC_channels` (channelName, channelPassword, IRC_servers_serverID, isJoined, lastOpened)</span>
<span class="s">        values(</span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">, CURRENT_TIMESTAMP) ON DUPLICATE KEY UPDATE `channelName` = `channelName`;&quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">channelName</span><span class="p">,</span> <span class="n">channelPassword</span><span class="p">,</span> <span class="n">serverID</span><span class="p">,</span> <span class="bp">False</span><span class="p">))</span>
        <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">res</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;status&quot;</span><span class="p">:</span> <span class="s">&quot;ok&quot;</span><span class="p">,</span> <span class="s">&quot;reason&quot;</span><span class="p">:</span> <span class="s">&quot;channel_added_sucessfully&quot;</span><span class="p">,</span> <span class="s">&quot;message&quot;</span><span class="p">:</span> <span class="s">&quot;Channel added successfully.&quot;</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;status&quot;</span><span class="p">:</span> <span class="s">&quot;ok&quot;</span><span class="p">,</span> <span class="s">&quot;reason&quot;</span><span class="p">:</span> <span class="s">&quot;channel_was_not_added&quot;</span><span class="p">,</span> <span class="s">&quot;message&quot;</span><span class="p">:</span> <span class="s">&quot;Channel cannot be added at this time.&quot;</span><span class="p">}</span> <span class="c"># error?</span>

        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">error</span><span class="p">(</span><span class="s">&quot;error&quot;</span><span class="p">,</span> <span class="s">&quot;not_loggedin&quot;</span><span class="p">,</span> <span class="s">&quot;You are not logged in.&quot;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-36'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-36'>#</a>
      </div>
      <p>routa volaná při zobrazení okna globálních nastavení</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/get_global_settings&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;POST&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">get_global_settings</span><span class="p">():</span>
    <span class="n">userID</span> <span class="o">=</span> <span class="n">get_userID_if_loggedin</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&quot;UserID = &quot;</span><span class="p">,</span> <span class="n">userID</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">userID</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">False</span><span class="p">:</span>
        <span class="n">db</span><span class="o">=</span><span class="n">MySQLdb</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="s">&quot;root&quot;</span><span class="p">,</span> <span class="n">passwd</span><span class="o">=</span><span class="s">&quot;asdf&quot;</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="s">&quot;cloudchatdb&quot;</span><span class="p">,</span> <span class="n">connect_timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">charset</span><span class="o">=</span><span class="s">&quot;utf8&quot;</span><span class="p">)</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;SELECT * FROM `User_settings` WHERE `Registred_users_userID` = </span><span class="si">%s</span><span class="s">;&quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">userID</span><span class="p">,))</span>
        <span class="k">if</span> <span class="n">res</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
            <span class="n">global_settings</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;status&quot;</span><span class="p">:</span> <span class="s">&quot;ok&quot;</span><span class="p">,</span> <span class="s">&quot;reason&quot;</span><span class="p">:</span> <span class="s">&quot;listing_settings&quot;</span><span class="p">,</span> <span class="s">&quot;message&quot;</span><span class="p">:</span> <span class="n">global_settings</span><span class="p">}</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;SETTINGS LISTED&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">res</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c"># global settings row for this user doesn&#39;t exist, let&#39;s create it</span>
            <span class="n">cursor</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;INSERT INTO `User_settings` (Registred_users_userID) values (</span><span class="si">%s</span><span class="s">);&quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">userID</span><span class="p">,))</span> <span class="c"># vytvoří defaultní nastavení pro uživatele, který ještě nastavení nemá</span>
            <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

            <span class="n">res2</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;SELECT * FROM `User_settings` WHERE `Registred_users_userID` = </span><span class="si">%s</span><span class="s">;&quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">userID</span><span class="p">,))</span> <span class="c"># it&#39;s redundant to select the settings if we know that we just inserted the default ones, but just to be sure</span>
            <span class="k">if</span> <span class="n">res2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
                <span class="n">global_settings</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
                <span class="n">response</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;status&quot;</span><span class="p">:</span> <span class="s">&quot;ok&quot;</span><span class="p">,</span> <span class="s">&quot;reason&quot;</span><span class="p">:</span> <span class="s">&quot;listing_settings&quot;</span><span class="p">,</span> <span class="s">&quot;message&quot;</span><span class="p">:</span> <span class="n">global_settings</span><span class="p">}</span> <span class="c"># vratí nastavení, kterými se naplní formulář s nastavením</span>
                <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">error</span><span class="p">(</span><span class="s">&quot;error&quot;</span><span class="p">,</span> <span class="s">&quot;db_error&quot;</span><span class="p">,</span> <span class="s">&quot;Database error.&lt;br&gt;Are you logged in?&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">error</span><span class="p">(</span><span class="s">&quot;ok&quot;</span><span class="p">,</span> <span class="s">&quot;no_servers_to_list&quot;</span><span class="p">,</span> <span class="s">&quot;Error loading your current settings, please try again later.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
         <span class="k">return</span> <span class="n">error</span><span class="p">(</span><span class="s">&quot;error&quot;</span><span class="p">,</span> <span class="s">&quot;not_loggedin&quot;</span><span class="p">,</span> <span class="s">&quot;You are not logged in.&quot;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-37'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-37'>#</a>
      </div>
      <p>routa volaná při uložení globálních nastavení v okně nastavení globálních nastavení</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/save_global_settings&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;POST&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">set_global_settings</span><span class="p">():</span>
    <span class="n">userID</span> <span class="o">=</span> <span class="n">get_userID_if_loggedin</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&quot;UserID = &quot;</span><span class="p">,</span> <span class="n">userID</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">userID</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">False</span><span class="p">:</span>
        <span class="n">settings_cols_names</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;highlight_words&quot;</span><span class="p">,</span> <span class="s">&quot;whois_username&quot;</span><span class="p">,</span> <span class="s">&quot;whois_realname&quot;</span><span class="p">,</span> <span class="s">&quot;global_nickname&quot;</span><span class="p">,</span> <span class="s">&quot;show_joinpartquit_messages&quot;</span><span class="p">,</span>
                              <span class="s">&quot;show_seconds&quot;</span><span class="p">,</span> <span class="s">&quot;show_video_previews&quot;</span><span class="p">,</span> <span class="s">&quot;show_image_previews&quot;</span><span class="p">]</span>
        <span class="n">settings_cols_values</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">settings_cols_names</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-38'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-38'>#</a>
      </div>
      <p>fix boolean values</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="k">if</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">==</span> <span class="s">&quot;true&quot;</span><span class="p">):</span>
                <span class="n">settings_cols_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">elif</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">==</span> <span class="s">&quot;false&quot;</span><span class="p">):</span>
                <span class="n">settings_cols_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">settings_cols_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>

        <span class="k">print</span><span class="p">(</span><span class="s">&quot;SETTINGS&quot;</span><span class="p">,</span> <span class="n">settings_cols_names</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">settings_cols_values</span><span class="p">)</span>

        <span class="n">db</span><span class="o">=</span><span class="n">MySQLdb</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="s">&quot;root&quot;</span><span class="p">,</span> <span class="n">passwd</span><span class="o">=</span><span class="s">&quot;asdf&quot;</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="s">&quot;cloudchatdb&quot;</span><span class="p">,</span> <span class="n">connect_timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">charset</span><span class="o">=</span><span class="s">&quot;utf8&quot;</span><span class="p">)</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;INSERT INTO `User_settings` (highlight_words,</span>
<span class="s">                                whois_username,</span>
<span class="s">                                whois_realname,</span>
<span class="s">                                global_nickname,</span>
<span class="s">                                show_joinpartquit_messages,</span>
<span class="s">                                show_seconds,</span>
<span class="s">                                show_video_previews,</span>
<span class="s">                                show_image_previews,</span>
<span class="s">                                Registred_users_userID)</span>
<span class="s">                                values (</span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">)</span>
<span class="s">                                ON DUPLICATE KEY UPDATE highlight_words=</span><span class="si">%s</span><span class="s">,</span>
<span class="s">                                whois_username=</span><span class="si">%s</span><span class="s">,</span>
<span class="s">                                whois_realname=</span><span class="si">%s</span><span class="s">,</span>
<span class="s">                                global_nickname=</span><span class="si">%s</span><span class="s">,</span>
<span class="s">                                show_joinpartquit_messages=</span><span class="si">%s</span><span class="s">,</span>
<span class="s">                                show_seconds=</span><span class="si">%s</span><span class="s">,</span>
<span class="s">                                show_video_previews=</span><span class="si">%s</span><span class="s">,</span>
<span class="s">                                show_image_previews=</span><span class="si">%s</span><span class="s">;&quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">settings_cols_values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                              <span class="n">settings_cols_values</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                                              <span class="n">settings_cols_values</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                                                              <span class="n">settings_cols_values</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
                                                              <span class="n">settings_cols_values</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
                                                              <span class="n">settings_cols_values</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
                                                              <span class="n">settings_cols_values</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span>
                                                              <span class="n">settings_cols_values</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span>
                                                              <span class="n">userID</span><span class="p">,</span>
                                                              <span class="n">settings_cols_values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                              <span class="n">settings_cols_values</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                                              <span class="n">settings_cols_values</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                                                              <span class="n">settings_cols_values</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
                                                              <span class="n">settings_cols_values</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
                                                              <span class="n">settings_cols_values</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
                                                              <span class="n">settings_cols_values</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span>
                                                              <span class="n">settings_cols_values</span><span class="p">[</span><span class="mi">7</span><span class="p">],))</span>
        <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;RES&quot;</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">res</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">error</span><span class="p">(</span><span class="s">&quot;ok&quot;</span><span class="p">,</span> <span class="s">&quot;global_settings_saved&quot;</span><span class="p">,</span> <span class="s">&quot;Global settings saved successfully.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">error</span><span class="p">(</span><span class="s">&quot;ok&quot;</span><span class="p">,</span> <span class="s">&quot;global_settings_notupdated&quot;</span><span class="p">,</span> <span class="s">&quot;No changes to save.&quot;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-39'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-39'>#</a>
      </div>
      <p>return error("error", "global_settings_not_found", "Global settings failed to save.")</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">error</span><span class="p">(</span><span class="s">&quot;error&quot;</span><span class="p">,</span> <span class="s">&quot;not_loggedin&quot;</span><span class="p">,</span> <span class="s">&quot;You are not logged in.&quot;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-40'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-40'>#</a>
      </div>
      <p>routa volaná při načtení chat.html
routa volaná při přidání / odstranění serveru
split with get_channel_list?</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/get_channel_list&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;POST&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">get_channel_list</span><span class="p">():</span>
    <span class="n">userID</span> <span class="o">=</span> <span class="n">get_userID_if_loggedin</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&quot;UserID = &quot;</span><span class="p">,</span> <span class="n">userID</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">userID</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">False</span><span class="p">:</span>
        <span class="n">db</span><span class="o">=</span><span class="n">MySQLdb</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="s">&quot;root&quot;</span><span class="p">,</span> <span class="n">passwd</span><span class="o">=</span><span class="s">&quot;asdf&quot;</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="s">&quot;cloudchatdb&quot;</span><span class="p">,</span> <span class="n">connect_timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">charset</span><span class="o">=</span><span class="s">&quot;utf8&quot;</span><span class="p">)</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;SELECT * FROM `IRC_servers` WHERE `Registred_users_userID` = </span><span class="si">%s</span><span class="s">;&quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">userID</span><span class="p">,))</span>
        <span class="k">if</span> <span class="n">res</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
            <span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;RESULT&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
            <span class="n">servers</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                <span class="n">server_dict_temp</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;serverID&quot;</span><span class="p">:</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                    <span class="s">&quot;serverSessionID&quot;</span><span class="p">:</span> <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                    <span class="s">&quot;nickname&quot;</span><span class="p">:</span> <span class="n">res</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                                    <span class="s">&quot;isAway&quot;</span><span class="p">:</span> <span class="n">res</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
                                    <span class="s">&quot;isConnected&quot;</span><span class="p">:</span> <span class="n">res</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
                                    <span class="s">&quot;Registred_users_userID&quot;</span><span class="p">:</span> <span class="n">res</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
                                    <span class="s">&quot;serverName&quot;</span><span class="p">:</span> <span class="n">res</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span>
                                    <span class="s">&quot;serverIP&quot;</span><span class="p">:</span> <span class="n">res</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span>
                                    <span class="s">&quot;serverPort&quot;</span><span class="p">:</span> <span class="n">res</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span>
                                    <span class="s">&quot;useSSL&quot;</span><span class="p">:</span> <span class="n">res</span><span class="p">[</span><span class="mi">9</span><span class="p">]}</span>
                <span class="n">servers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">server_dict_temp</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span>

            <span class="n">response</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;status&quot;</span><span class="p">:</span> <span class="s">&quot;ok&quot;</span><span class="p">,</span> <span class="s">&quot;reason&quot;</span><span class="p">:</span> <span class="s">&quot;listing_servers&quot;</span><span class="p">,</span> <span class="s">&quot;message&quot;</span><span class="p">:</span> <span class="n">servers</span><span class="p">}</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">error</span><span class="p">(</span><span class="s">&quot;ok&quot;</span><span class="p">,</span> <span class="s">&quot;no_servers_to_list&quot;</span><span class="p">,</span> <span class="s">&quot;No servers yet.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">error</span><span class="p">(</span><span class="s">&quot;error&quot;</span><span class="p">,</span> <span class="s">&quot;not_loggedin&quot;</span><span class="p">,</span> <span class="s">&quot;You are not logged in.&quot;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-41'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-41'>#</a>
      </div>
      <p>called to prefill the inputs when user edits a server</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/get_server_settings&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;POST&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">get_server_settings</span><span class="p">():</span>
    <span class="n">userID</span> <span class="o">=</span> <span class="n">get_userID_if_loggedin</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="n">serverID</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;serverID&quot;</span><span class="p">)</span> <span class="c"># gets the serverID of the server the user wants to edit from the ajax request</span>

    <span class="k">print</span><span class="p">(</span><span class="s">&quot;UserID = &quot;</span><span class="p">,</span> <span class="n">userID</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">userID</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">False</span><span class="p">:</span>
        <span class="n">db</span><span class="o">=</span><span class="n">MySQLdb</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="s">&quot;root&quot;</span><span class="p">,</span> <span class="n">passwd</span><span class="o">=</span><span class="s">&quot;asdf&quot;</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="s">&quot;cloudchatdb&quot;</span><span class="p">,</span> <span class="n">connect_timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">charset</span><span class="o">=</span><span class="s">&quot;utf8&quot;</span><span class="p">)</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;SELECT * FROM `IRC_servers` WHERE `Registred_users_userID` = </span><span class="si">%s</span><span class="s"> AND `serverID` = </span><span class="si">%s</span><span class="s">;&quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">userID</span><span class="p">,</span> <span class="n">serverID</span><span class="p">))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-42'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-42'>#</a>
      </div>
      <p>res = cursor.execute("""SHOW COLUMNS FROM <code>IRC_servers</code>;""")</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">result</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
        <span class="n">response</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;status&quot;</span><span class="p">:</span> <span class="s">&quot;ok&quot;</span><span class="p">,</span> <span class="s">&quot;reason&quot;</span><span class="p">:</span> <span class="s">&quot;listing_server_info&quot;</span><span class="p">,</span> <span class="s">&quot;message&quot;</span><span class="p">:</span> <span class="n">result</span><span class="p">}</span>
        <span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">error</span><span class="p">(</span><span class="s">&quot;error&quot;</span><span class="p">,</span> <span class="s">&quot;not_loggedin&quot;</span><span class="p">,</span> <span class="s">&quot;You are not logged in.&quot;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-43'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-43'>#</a>
      </div>
      <p>called to prefill the inputs when user edits a server</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/edit_server_settings&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;POST&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">edit_server_settings</span><span class="p">():</span>
    <span class="n">userID</span> <span class="o">=</span> <span class="n">get_userID_if_loggedin</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="n">serverID</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;serverID&quot;</span><span class="p">)</span> <span class="c"># gets the serverID of the server the user wants to edit from the ajax request</span>

    <span class="n">klice</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;serverName&quot;</span><span class="p">:</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;nickname&quot;</span><span class="p">:</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;serverPassword&quot;</span><span class="p">:</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;serverIP&quot;</span><span class="p">:</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;serverPort&quot;</span><span class="p">:</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;useSSL&quot;</span><span class="p">:</span><span class="s">&quot;&quot;</span><span class="p">}</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">klice</span><span class="p">:</span>
        <span class="n">klice</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

    <span class="k">print</span><span class="p">(</span><span class="s">&quot;UserID = &quot;</span><span class="p">,</span> <span class="n">userID</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">userID</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">False</span><span class="p">:</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">MySQLdb</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="s">&quot;root&quot;</span><span class="p">,</span> <span class="n">passwd</span><span class="o">=</span><span class="s">&quot;asdf&quot;</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="s">&quot;cloudchatdb&quot;</span><span class="p">,</span> <span class="n">connect_timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">charset</span><span class="o">=</span><span class="s">&quot;utf8&quot;</span><span class="p">)</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-44'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-44'>#</a>
      </div>
      <p>zjitíme, zda server, který se uživatel snaží editovat je opravdu jeho</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;SELECT Registred_users_userID,serverID FROM `IRC_servers` WHERE `Registred_users_userID` = </span><span class="si">%s</span><span class="s"> AND `serverID` = </span><span class="si">%s</span><span class="s">;&quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">userID</span><span class="p">,</span> <span class="n">serverID</span><span class="p">))</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">userID</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">serverID</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;This is userID&#39;s server. yeah boy.&quot;</span><span class="p">)</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;UPDATE `IRC_servers` SET serverName=</span><span class="si">%s</span><span class="s">,</span>
<span class="s">                                 nickname=</span><span class="si">%s</span><span class="s">,</span>
<span class="s">                                 serverPassword=</span><span class="si">%s</span><span class="s">,</span>
<span class="s">                                 serverIP=</span><span class="si">%s</span><span class="s">,</span>
<span class="s">                                 serverPort=</span><span class="si">%s</span><span class="s">,</span>
<span class="s">                                 useSSL=</span><span class="si">%s</span><span class="s"> WHERE `serverID` = </span><span class="si">%s</span><span class="s">;&quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">klice</span><span class="p">[</span><span class="s">&quot;serverName&quot;</span><span class="p">],</span> <span class="n">klice</span><span class="p">[</span><span class="s">&quot;nickname&quot;</span><span class="p">],</span> <span class="n">klice</span><span class="p">[</span><span class="s">&quot;serverPassword&quot;</span><span class="p">],</span> <span class="n">klice</span><span class="p">[</span><span class="s">&quot;serverIP&quot;</span><span class="p">],</span> <span class="n">klice</span><span class="p">[</span><span class="s">&quot;serverPort&quot;</span><span class="p">],</span> <span class="n">klice</span><span class="p">[</span><span class="s">&quot;useSSL&quot;</span><span class="p">],</span> <span class="n">serverID</span><span class="p">))</span>

            <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">res</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;status&quot;</span><span class="p">:</span> <span class="s">&quot;ok&quot;</span><span class="p">,</span> <span class="s">&quot;reason&quot;</span><span class="p">:</span> <span class="s">&quot;server_settings_edited_successfully&quot;</span><span class="p">,</span> <span class="s">&quot;message&quot;</span><span class="p">:</span> <span class="s">&quot;Server settings edited successfully.&lt;br&gt;Sending reconnect request.&quot;</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;status&quot;</span><span class="p">:</span> <span class="s">&quot;ok&quot;</span><span class="p">,</span> <span class="s">&quot;reason&quot;</span><span class="p">:</span> <span class="s">&quot;server_settings_not_edited&quot;</span><span class="p">,</span> <span class="s">&quot;message&quot;</span><span class="p">:</span> <span class="s">&quot;Server settings were not updated.&quot;</span><span class="p">}</span> <span class="c"># error?</span>

        <span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">error</span><span class="p">(</span><span class="s">&quot;error&quot;</span><span class="p">,</span> <span class="s">&quot;not_loggedin&quot;</span><span class="p">,</span> <span class="s">&quot;You are not logged in.&quot;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-45'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-45'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/add_new_server_settings&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;POST&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">add_new_server_settings</span><span class="p">():</span>
    <span class="n">userID</span> <span class="o">=</span> <span class="n">get_userID_if_loggedin</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">userID</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">False</span><span class="p">:</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">MySQLdb</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="s">&quot;root&quot;</span><span class="p">,</span> <span class="n">passwd</span><span class="o">=</span><span class="s">&quot;asdf&quot;</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="s">&quot;cloudchatdb&quot;</span><span class="p">,</span> <span class="n">connect_timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">charset</span><span class="o">=</span><span class="s">&quot;utf8&quot;</span><span class="p">)</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">klice</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;serverName&quot;</span><span class="p">:</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;nickname&quot;</span><span class="p">:</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;serverPassword&quot;</span><span class="p">:</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;serverIP&quot;</span><span class="p">:</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;serverPort&quot;</span><span class="p">:</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;useSSL&quot;</span><span class="p">:</span><span class="s">&quot;&quot;</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">klice</span><span class="p">:</span>
            <span class="n">klice</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">a</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-46'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-46'>#</a>
      </div>
      <p>přidáme server</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;INSERT INTO `IRC_servers` (Registred_users_userID, serverName, nickname, serverPassword, serverIP, serverPort, useSSL, serverSessionID, isAway, isConnected)</span>
<span class="s">        values(</span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">, -1, 0, 0);&quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">userID</span><span class="p">,</span> <span class="n">klice</span><span class="p">[</span><span class="s">&quot;serverName&quot;</span><span class="p">],</span> <span class="n">klice</span><span class="p">[</span><span class="s">&quot;nickname&quot;</span><span class="p">],</span> <span class="n">klice</span><span class="p">[</span><span class="s">&quot;serverPassword&quot;</span><span class="p">],</span> <span class="n">klice</span><span class="p">[</span><span class="s">&quot;serverIP&quot;</span><span class="p">],</span> <span class="n">klice</span><span class="p">[</span><span class="s">&quot;serverPort&quot;</span><span class="p">],</span> <span class="n">klice</span><span class="p">[</span><span class="s">&quot;useSSL&quot;</span><span class="p">]))</span>
        <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">res</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;status&quot;</span><span class="p">:</span> <span class="s">&quot;ok&quot;</span><span class="p">,</span> <span class="s">&quot;reason&quot;</span><span class="p">:</span> <span class="s">&quot;server_settings_edited_successfully&quot;</span><span class="p">,</span> <span class="s">&quot;message&quot;</span><span class="p">:</span> <span class="s">&quot;Server settings edited successfully.&lt;br&gt;Sending reconnect request.&quot;</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;status&quot;</span><span class="p">:</span> <span class="s">&quot;ok&quot;</span><span class="p">,</span> <span class="s">&quot;reason&quot;</span><span class="p">:</span> <span class="s">&quot;server_settings_not_edited&quot;</span><span class="p">,</span> <span class="s">&quot;message&quot;</span><span class="p">:</span> <span class="s">&quot;Server settings were not updated.&quot;</span><span class="p">}</span> <span class="c"># error?</span>

        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">error</span><span class="p">(</span><span class="s">&quot;error&quot;</span><span class="p">,</span> <span class="s">&quot;not_loggedin&quot;</span><span class="p">,</span> <span class="s">&quot;You are not logged in.&quot;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-47'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-47'>#</a>
      </div>
      <p>routa volaná při volbě kanálu ze seznamu, routa volaná při scrollnutí nahoru v chatovacím okénku pro získání více zpráv z minulosti
TODO: fix sql?
, (channelID, sinceTimestamp, messageLimit)</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/get_messages&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;POST&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">get_messages</span><span class="p">():</span>
    <span class="n">userID</span> <span class="o">=</span> <span class="n">get_userID_if_loggedin</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&quot;UserID = &quot;</span><span class="p">,</span> <span class="n">userID</span><span class="p">)</span>

    <span class="n">backlog</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;backlog&quot;</span><span class="p">)))</span> <span class="c"># rozhoduje zda budeme vracet backlog nebo nejnovější zprávy od minule</span>
    <span class="n">channelID</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;channelID&quot;</span><span class="p">)</span> <span class="c"># channelID</span>
    <span class="n">messageLimit</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;limit&quot;</span><span class="p">))</span> <span class="ow">or</span> <span class="mi">20</span> <span class="c"># limit zpráv, které získáváme z db</span>

    <span class="k">if</span> <span class="n">userID</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">False</span><span class="p">:</span>
        <span class="n">db</span><span class="o">=</span><span class="n">MySQLdb</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="s">&quot;root&quot;</span><span class="p">,</span> <span class="n">passwd</span><span class="o">=</span><span class="s">&quot;asdf&quot;</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="s">&quot;cloudchatdb&quot;</span><span class="p">,</span> <span class="n">connect_timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">charset</span><span class="o">=</span><span class="s">&quot;utf8&quot;</span><span class="p">)</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;SELECT * FROM `IRC_channels` WHERE `channelID` = </span><span class="si">%s</span><span class="s">;&quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">channelID</span><span class="p">,))</span> <span class="c">#query to find the serverID so we can check if the user owns this serverID and is not trying to read something that is not his</span>
        <span class="k">if</span> <span class="n">res</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
            <span class="n">serverID_result</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span> <span class="c"># 5 = IRC_servers_serverID</span>

            <span class="k">if</span> <span class="n">check_if_serverID_belongs_to_userID</span><span class="p">(</span><span class="n">userID</span><span class="p">,</span> <span class="n">serverID_result</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&quot;THIS IS YOUR CHANNEL LOL&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">backlog</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span> <span class="c"># if we want to load messages for a channel we are opening for the first time this session</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&quot;Welcome, this is the backlog chapter of the video game called getting messages.&quot;</span><span class="p">)</span>

                    <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>

<span class="s">                    (SELECT *</span>
<span class="s">                    FROM `IRC_channel_messages`</span>
<span class="s">                    WHERE `IRC_channels_channelID` = </span><span class="si">%s</span><span class="s"></span>
<span class="s">                    ORDER BY `messageID` DESC LIMIT </span><span class="si">%s</span><span class="s">)</span>
<span class="s">                    ORDER BY `messageID` ASC;&quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">channelID</span><span class="p">,</span> <span class="n">messageLimit</span><span class="p">)</span>
                                         <span class="p">)</span> <span class="c"># query to get the backlog if the message window was opened just now</span>
                    <span class="k">if</span> <span class="n">res</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
                        <span class="k">print</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">\MRDKY</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
                        <span class="n">messages</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

                        <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                            <span class="k">print</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
                            <span class="n">dateTime</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                            <span class="k">print</span><span class="p">(</span><span class="s">&quot;dateTime = &quot;</span><span class="p">,</span> <span class="n">dateTime</span><span class="p">)</span>
                            <span class="kn">import</span> <span class="nn">time</span>
                            <span class="n">utc_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">dateTime</span><span class="o">.</span><span class="n">timetuple</span><span class="p">())</span> <span class="o">*</span> <span class="mi">1000</span>

                            <span class="n">server_dict_temp</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;messageID&quot;</span><span class="p">:</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                <span class="s">&quot;fromHostmask&quot;</span><span class="p">:</span> <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                <span class="s">&quot;messageBody&quot;</span><span class="p">:</span> <span class="n">res</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                                <span class="s">&quot;commandType&quot;</span><span class="p">:</span> <span class="n">res</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
                                <span class="s">&quot;timeReceived&quot;</span><span class="p">:</span> <span class="n">utc_time</span><span class="p">,</span>
                                <span class="s">&quot;seen&quot;</span><span class="p">:</span> <span class="n">res</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
                                <span class="s">&quot;IRC_channels_channelID&quot;</span><span class="p">:</span> <span class="n">res</span><span class="p">[</span><span class="mi">6</span><span class="p">]}</span>
                            <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">server_dict_temp</span><span class="p">)</span>
                            <span class="k">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">4</span><span class="p">]))</span>
                        <span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                        <span class="n">response</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;status&quot;</span><span class="p">:</span> <span class="s">&quot;ok&quot;</span><span class="p">,</span> <span class="s">&quot;reason&quot;</span><span class="p">:</span> <span class="s">&quot;listing_messages&quot;</span><span class="p">,</span> <span class="s">&quot;message&quot;</span><span class="p">:</span> <span class="n">messages</span><span class="p">}</span>
                        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&quot;Welcome, this is the NEW MESSAGES chapter of the video game called getting messages.&quot;</span><span class="p">)</span>

                    <span class="n">messageLimit</span> <span class="o">=</span> <span class="mi">10000000</span>
                    <span class="n">sinceTimestamp</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;sinceTimestamp&quot;</span><span class="p">)</span> <span class="c"># load messages posted since a given time</span>

                    <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">                    (SELECT * FROM `IRC_channel_messages`</span>
<span class="s">                    WHERE `IRC_channels_channelID` = </span><span class="si">%s</span><span class="s"></span>
<span class="s">					AND `messageID` &gt; </span><span class="si">%s</span><span class="s"></span>
<span class="s">                    ORDER BY `messageID` DESC LIMIT </span><span class="si">%s</span><span class="s">)</span>
<span class="s">                    ORDER BY `messageID` ASC;</span>
<span class="s">#DIVIDER</span>
<span class="s">                    print(&quot;&quot;&quot;</span>
                    <span class="p">(</span><span class="n">SELECT</span> <span class="o">*</span> <span class="n">FROM</span> <span class="sb">`IRC_channel_messages`</span>
                    <span class="n">WHERE</span> <span class="sb">`IRC_channels_channelID`</span> <span class="o">=</span> <span class="o">%</span><span class="n">s</span>
					<span class="n">AND</span> <span class="sb">`messageID`</span> <span class="o">&gt;=</span> <span class="o">%</span><span class="n">s</span>
                    <span class="n">ORDER</span> <span class="n">BY</span> <span class="sb">`messageID`</span> <span class="n">DESC</span> <span class="n">LIMIT</span> <span class="o">%</span><span class="n">s</span><span class="p">)</span>
                    <span class="n">ORDER</span> <span class="n">BY</span> <span class="sb">`messageID`</span> <span class="n">ASC</span><span class="p">;</span>
                    <span class="s">&quot;&quot;&quot; % (channelID, sinceTimestamp, messageLimit))</span>

<span class="s">                    if res != 0:</span>
<span class="s">                        result = cursor.fetchall()</span>
<span class="s">                        print(&quot;</span><span class="se">\n</span><span class="s">\MRDKY</span><span class="se">\n\n</span><span class="s">&quot;, result)</span>
<span class="s">                        messages = list()</span>

<span class="s">                        for res in result:</span>
<span class="s">                            print(res)</span>
<span class="s">                            dateTime = res[4]</span>
<span class="s">                            import time</span>
<span class="s">                            utc_time = time.mktime(dateTime.timetuple()) * 1000</span>

<span class="s">                            server_dict_temp = {&quot;messageID&quot;: res[0],</span>
<span class="s">                                &quot;fromHostmask&quot;: res[1],</span>
<span class="s">                                &quot;messageBody&quot;: res[2],</span>
<span class="s">                                &quot;commandType&quot;: res[3],</span>
<span class="s">                                &quot;timeReceived&quot;: utc_time,</span>
<span class="s">                                &quot;seen&quot;: res[5],</span>
<span class="s">                                &quot;IRC_channels_channelID&quot;: res[6]}</span>
<span class="s">                            messages.append(server_dict_temp)</span>
<span class="s">                            print(type(res[4]))</span>
<span class="s">                        db.close()</span>
<span class="s">                        response = {&quot;status&quot;: &quot;ok&quot;, &quot;reason&quot;: &quot;listing_new_messages&quot;, &quot;message&quot;: messages}</span>
<span class="s">                        return jsonify(response)</span>
<span class="s">                    else:</span>
<span class="s">                        db.close()</span>
<span class="s">                        response = {&quot;status&quot;: &quot;ok&quot;, &quot;reason&quot;: &quot;no_new_messages&quot;, &quot;message&quot;: &quot;No new messages since {0}&quot;.format(sinceTimestamp)}</span>
<span class="s">                        return jsonify(response)</span>

<span class="s">            else:</span>
<span class="s">                db.close()</span>
<span class="s">                return error(&quot;error&quot;, &quot;channel_is_not_yours&quot;, &quot;A channel with this channelID does not belong to your account.&quot;)</span>


<span class="s">        else:</span>
<span class="s">            db.close()</span>
<span class="s">            return error(&quot;error&quot;, &quot;channelid_does_not_exist&quot;, &quot;A channel with the requested channelID does not exist.&quot;)</span>
<span class="s">    else:</span>
<span class="s">         return error(&quot;error&quot;, &quot;not_loggedin&quot;, &quot;You are not logged in.&quot;)</span>



<span class="s">if __name__ == &#39;__main__&#39;:</span>
<span class="s">    app.run(debug=True, host=&quot;0.0.0.0&quot;) # TODO: remove binding on all interfaces; this is only here for debugging</span>

</pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-48'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-48'>#</a>
      </div>
      <pre><code>                 ) #
</code></pre>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
</div>
</body>
